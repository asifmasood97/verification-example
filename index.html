<!DOCTYPE html>
<html>

<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=5.0">
	<meta http-equiv="x-ua-compatible" content="IE=Edge">
	<title>Verification Example</title>
	<style>
		iframe.hidden {
			display: none;
		}

		iframe.visible {
			border: none;
			height: 90vh;
			width: 90vw;
			max-width: 40em;
		}
	</style>
	<script>
		// const baseUrl = "https://merchant.intergiro.com/v1"
		// const key = "Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJodHRwczovL2FwaS5wYXlmdW5jLmNvbSIsImlhdCI6MTYyMzQyNjE2NSwibmFtZSI6InRlc3R0ZXN0IiwidXJsIjoid3d3LmV4YW1wbGUuY29tIiwiZW1haWwiOiJSTExCNGdOaVBzYk9LYUlEYmgzRGFDYnd4WWlGb3lmeVI4dkU2TnFJQ2NObThKcGhwRWViRkZfSmgzeVhSZjdpU3NJN250dy1mRW5Qeml1WU5NeU82bWRwTFhsNE0zQnJOWEJEZFVFaUxDSnViM1JwWm5raU9pSWlmUSIsImNhcmQiOnsiYWNxdWlyZXIiOiJMczZXbkVLdEtkcW9iY1RQTW9QdlhOanlhNVUwRnpaRWJ4dEpPZlNlQml5c3REYkVlN25DVkhkcEVWcWViWnJJMVp1ODJZN2U4RDF3X2FKclJ2dXdleUp3Y205MGIyTnZiQ0k2SW1sdWRHVnlaMmx5YnlJc0luVnliQ0k2SW1oMGRIQnpPaTh2WVhCcExuQmhlV1oxYm1NdVkyOXRJbjAiLCJjb3VudHJ5IjoiU0UiLCJkZXNjcmlwdG9yIjoidGVzdCB0cmFuc2FjdGlvbiIsImVtdjNkIjoiSWEzOTRhRWJNVTdrdVJIdDRxNlUzZGd0dzIzZmg4UFRPTXpiRjF4c0xPWW1aR3FHUTJtdl9rdXdBWllMSmltX1pwakc0UjdWRVpva0pwamhXOGdleGlJc0luVnliQ0k2SW1oMGRIQnpPaTh2YzJWeWRtbGpaUzV6WVc1a1ltOTRMak5rYzJWamRYSmxMbWx2SW4wc2V5SndjbTkwYjJOdmJDSTZJbU5vTTJReElpd2lkWEpzSWpvaWFIUjBjSE02THk5aGNHa3VZMkZ5WkdaMWJtTXVZMjl0TDJOb00yUXhjMmx0SWl3aWEyVjVJam9pYm04dGEyVjVJbjFkIiwiaWQiOiJ0ZXN0IiwibWNjIjoiMTIzNCIsIm1pZCI6IjgxMDMwMDAxMTEiLCJ1cmwiOiJodHRwczovL2FwaS5wYXlmdW5jLmNvbSJ9LCJzdWIiOiJ0ZXN0dGVzdCIsImFnZW50IjoidGVzdCIsImF1ZCI6InB1YmxpYyIsImZlYXR1cmVzIjoiIn0.0FLx7wI4f0r7Rmi6g5ALeR38p8dJ307A9TZJ6-C2iAw"
		const baseUrl = "http://127.0.0.1"
		const verificationUrl = ":7112"
		const authorizationUrl = ":7106"
		const key = "Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJodHRwOi8vbG9jYWxob3N0OjcwNzEiLCJpYXQiOjE2MDM0Mzc0MDQsIm5hbWUiOiJzaWx2ZmxvdyIsInVybCI6Ind3dy5leGFtcGxlLmNvbSIsImVtYWlsIjoiWG5JcUJuZWRmQ3BkQjlxVUE5a2RpWXdWeXBPckY2U1VMS0RpNGMzLUdXVkZEelJXdTlaVHpwSnhSWGlQX2g4alRlUk9odWhGOS01LVd2VlJpcHFLYUdkcExYbDRNM0JyTlhCRGRVRWlMQ0p1YjNScFpua2lPaUpvZEhSd2N6b3ZMM0IwYzNZeUxtTnZiUzkwTDJKcGVXZzFMVEUxT0RjMk5UVTBNVEV2Y0c5emRDSjkiLCJjYXJkIjp7ImFjcXVpcmVyIjoiaFpqcy11bEtTZTJsc0xVWHUyU0QwYS1Eb3JoTU5VMXdpWHo2SXhGd2dXSHZaWEswek5manpWanpVeEZvVHg2bDBBdWJiSFBjdnp4TG9KVEI1LUxZOWlKd2NtOTBiMk52YkNJNkltbHVkR1Z5WjJseWJ5SXNJblZ5YkNJNkltaDBkSEJ6T2k4dllYQnBMbkJoZVdaMWJtTXVZMjl0SW4wIiwiY291bnRyeSI6IlNFIiwiZGVzY3JpcHRvciI6InRlc3QgdHJhbnNhY3Rpb24iLCJlbXYzZCI6IjBReHJfaWlQRFRudzVQdE5rQk9wQmR1SzF6QUpZOFZIOFpPUTYtUjBWRmJnaDNGREdESzdJUlIyeEE5VEREWnU2cEtYc0x2UWx3dmV2UFZkT3JqU1BDSXNJblZ5YkNJNkltaDBkSEJ6T2k4dmMyVnlkbWxqWlM1ellXNWtZbTk0TGpOa2MyVmpkWEpsTG1sdkluMWQiLCJpZCI6InRlc3QiLCJtY2MiOiIxMjM0IiwibWlkIjoiODEwMzAwMDExMSIsInVybCI6Imh0dHBzOi8vYXBpLnBheWZ1bmMuY29tIn0sInN1YiI6IlJrcXBkNnBRIiwiYXVkIjoicHVibGljIiwiZmVhdHVyZXMiOiJkZWZlckFsbG93ZWQgZW1haWxPcHRpb24iLCJhZ2VudCI6Im1hc3RlciJ9.0qHGTUOrasxlY2pT0_xyZTRFjP5FouH8ZYMYuVHpnuY"
		let authorization = {
			"number": "Number",
			"amount": 250,
			"currency": "EUR",
			"card": {
				"pan": "4111111111111111",
				"expires": [
					2,
					22
				],
				"csc": "987"
			}
		}
		async function authorize() {
			console.log("i try post")
			const [status, body] = await post(baseUrl + authorizationUrl + "/authorization", key, authorization)
			console.log("i trued post")
			switch (status) {
				case 201:
					alert("success: " + JSON.stringify(body))
					break
				case 400:
					if (body.error == "verification required")
						verify(authorization)
					else
						alert("failed: " + JSON.stringify(body))
					break
				default:
					alert("failed: " + JSON.stringify(body))
					break
			}
		}
		let iframeOrigin
		async function verify() {
			const [status, body] = await post(baseUrl + verificationUrl + "/verification", key, {
				items: authorization.amount,
				number: authorization.number,
				currency: authorization.currency,
				card: authorization.card,
				browser: window.location.origin
			})
			switch (status) {
				case 200:
					authorization.card.verification = body
					await authorize()
					break
				case 400:
					if (body.error == "verification required" && body.content.details == "GET") {
						const iframe = document.getElementById("verification")
						iframe.class = body.content.details.visible ? "visible" : "hidden"
						iframeOrigin = new URL(body.content.details.url).origin
						iframe.src = body.content.details.url + "&parent=" + encodeURIComponent(window.location.origin)
					} else
						alert("failed: " + JSON.stringify(body))
					break
				default:
					alert("failed: " + JSON.stringify(body))
					break
			}
		}
		window.addEventListener("message", async e => {
			if (iframeOrigin && e.origin == iframeOrigin && e.data.destination == "parent" && e.data.message.name == "card") {
				const iframe = document.getElementById("verification")
				iframe.class = "hidden"
				authorization.card.verification = e.data.message.value
				await authorize()
			}
		})
		async function post(url, key, body) {
			const response = await fetch(url, {
				method: "POST",
				headers: new Headers(
					{
						Authorization: key,
						"Content-Type": "application/json"
					}),
				body: JSON.stringify(body),
			}
			)
			return [response.status, response.headers.get("Content-Type")?.startsWith("application/json") ? await response.json() : await response.text()]
		}
// TODO: Start worker-verification and test.
	</script>
</head>

<body style="width: 100%; max-width: 20em; margin-left: auto; margin-right: auto;">
	<iframe id="verification" class="hidden"></iframe>
	<form method="post">
		<label for="pan">PAN</label>
		<input type="text" id="pan" name="pan" value="" />
		<label for="csc">CSC</label>
		<input type="text" id="csc" name="csc" value="" />
		<label for="expires">Expires</label>
		<input type="text" id="expires" name="expires" value="" />
	</form>
	<button onclick="authorize()">3Ds</button>
</body>

</html>